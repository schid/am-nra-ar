YUI.add("videoplayer",function(e,t){function n(){n.superclass.constructor.apply(this,arguments)}n.ATTRS={},n.NAME="videoPlayer",n.POSTER_TEMPLATE='<div id="poster"><div id="poster-container"><div id="html-poster-stop" class="vdgm-icon-stop icon-stop"></div><div id="html-poster-play" class="vdgm-icon-play icon-play"></div></div><img src="{poster_url}"></div>',n.HTML_VIDEO_TEMPLATE='<video controls preload="auto"><source src="{videoUrl}" type="video/mp4"></video>',n.ANDROID_VIDEO_TEMPLATE='<video controls preload="auto"><source src="{videoUrl}" type="video/mp4"></video>',n.GET_FLASH_TEMPLATE='<div class="no-flash"><p><a href="http://get.adobe.com/flashplayer/">Please install <strong>Adobe Flash Player</strong> to view this content.</a></p></div>',e.namespace("Vdgm").VideoPlayer=e.Base.create("videoPlayer",e.Widget,[e.WidgetParent,e.WidgetChild],{_assetPath:"@ASSETPATH@",_techs:{flash:{renderUI:"_renderFlashVideo",bindUI:"_bindFlashVideo",play:"_playFlashVideo",pause:"_pauseFlashVideo",stop:"_stopFlashVideo",destructor:"_destroyFlashVideo",remove:"_removeFlashVideo"},html:{renderUI:"_renderHtmlVideo",bindUI:"_bindHtmlVideo",play:"_playHtmlVideo",pause:"_pauseHtmlVideo",stop:"_stopHtmlVideo",destructor:"_destroyHtmlVideo",remove:"_removeHtmlVideo"}},_percentPlayed:0,toggleLarge:function(){this.fire("togglelargeview")},initializer:function(t){var n=this;this.model=t.model,this.host=t.host,this.f4mhost=t.f4mhost?t.f4mhost:null,this.flashLiveStream=t.settings.flash,this.htmlLiveStream=t.settings.html,this.tintColor=t.settings.tintColor,this.tech=t.tech||this.getTech(e.UA),this.type=this.model.type,this.embed=this.model.embed,this.duration=this.model.duration?this.model.duration:0,this.meta=this.model.meta?this.model.meta:[],n.isPaused=!1,n.started=!1,this.mapTech(),this.on("destroy",this.destructor,this),t.autoplay||(n._autoplay=!1)},getTech:function(t){var n=function(){return typeof ActiveXObject!="undefined"?typeof navigator.plugins=="undefined"||navigator.plugins.length==0?!!(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")):navigator.plugins["Shockwave Flash"]:typeof navigator.plugins=="undefined"||navigator.plugins.length==0?!1:navigator.plugins["Shockwave Flash"]};return e.UA.flashMajor!=null||n()?"flash":"html"},getVideo:function(t){return e.Array.filter(this.model.videos,function(e){return e.type===t})[0]},mapTech:function(){this._mapToTech("renderUI"),this._mapToTech("bindUI"),this._mapToTech("play"),this._mapToTech("pause"),this._mapToTech("stop"),this._mapToTech("destructor"),this._mapToTech("remove")},_mapToTech:function(e){var t=this;t[e]=function(){t[t._techs[t.tech][e]].call(t,arguments)}},_video:null,_renderHtmlVideo:function(){var t,r=n.HTML_VIDEO_TEMPLATE,i=this.get("contentBox");this.contentBox="contentBox",this.timeIterator=0,this.model.type=="live"?t={videoUrls:{html:""}}:this.model.type=="archive"?t={videoUrls:{html:e.Lang.sub(n.ARCHIVE_HTML_VIDEO_TEMPLATE,{videoPath:this.model.slug})}}:t=this.getVideo("hd")?this.getVideo("hd"):this.getVideo("ios").videoUrls.ios,t||(t=this.getVideo("mobhigh")),t||(t=this.getVideo("high")),this._poster=i.appendChild(e.Lang.sub(n.POSTER_TEMPLATE,{poster_url:this._getPosterImage()})),this._video=i.appendChild(e.Lang.sub(r,{videoUrl:t})),this._poster.one("#html-poster-stop").once("click",function(){this.stop()},this),this._poster.one("#html-poster-play").once("click",function(){this._video.invoke("play"),this._poster.remove(!0)},this)},_addDescriptionCloseButton:function(){var t=this,n=e.one("#embed-player"),r=n.one("#control-buttons"),i=e.Node.create('<div class="vdgm-icon-cancel-circle"></div>');n.one(".vdgm-sharebar").prepend(i),i.detach("click"),i.on("click",function(){t._track("VideoDescriptionClosed"),t.isPaused==1&&t.started&&t.play(),n.replaceClass("info-active","info-inactive"),n.one(".vdgm-sharebar").one(".vdgm-icon-cancel-circle").remove(),t._addDescriptionButton()})},_addDescriptionButton:function(){var t=this,n=e.one("#embed-player"),r=e.Node.create('<div class="vdgm-icon-info"></div>');n.one(".vdgm-sharebar").prepend(r),r.detach("click"),r.on("click",function(e){t._track("VideoDescriptionOpened"),n.one(".vdgm-icon-info").remove(),t._addDescriptionCloseButton(),n.replaceClass("info-inactive","info-active"),t.isPaused==0&&t.started&&t.pause()})},_bindHtmlVideo:function(){this._video.on("play",this._htmlEventHandler,this),this._video.on("pause",this._htmlEventHandler,this),this._video.on("ended",this._htmlEventHandler,this),this._video.on("timeupdate",this._htmlEventHandler,this),this._video.on("seeked",this._htmlEventHandler,this)},_htmlEventHandler:function(e){var t=this["_html_"+e.type];typeof t=="function"&&t.call(this,e)},_html_timeupdate:function(e){var t=this._video.getDOMNode(),n=t.currentTime;if(this.meta&&this.meta.length>0&&this.meta.length>this.timeIterator){var r=Number(this.meta[this.timeIterator].offset);n>r&&(this.fire("updateMeta",{currentTime:n,meta:this.meta}),this.timeIterator++)}this._percentPlayed<25?n/this.duration>=.25&&(this._track("PercentPlayed25"),this._percentPlayed=25):this._percentPlayed<50?n/this.duration>=.5&&(this._track("PercentPlayed50"),this._percentPlayed=50):this._percentPlayed<75?n/this.duration>=.75&&(this._track("PercentPlayed75"),this._percentPlayed=75):this._percentPlayed<90&&n/this.duration>=.9&&(this._track("PercentPlayed90"),this._percentPlayed=90),this._loadStarted||(this.model.timeoffset&&(this._video.getDOMNode().currentTime=Number(this.model.timeoffset),this.fire("updateMeta",{currentTime:Number(this.model.timeoffset),meta:this.meta})),this._loadStarted=!0)},_html_seeked:function(e){var t=this._video.getDOMNode(),n=t.currentTime;this.fire("updateMeta",{currentTime:n,meta:this.meta}),this.timeIterator=0},_html_play:function(e){this._track("Start"),this.fire("play"),this.get("contentBox").addClass("html-active"),this.isPaused=!1,this.started=!0,this._video.setAttribute("controls","true"),this._html_play=function(e){this.get("contentBox").addClass("html-active"),this._video.setAttribute
("controls","true"),this.fire("play")}},_html_pause:function(e){this._video.removeAttribute("controls");var t=this,n=this._video.get("ended"),r=this.get("contentBox");n||(this._track("Pause"),this.fire("pause")),r.removeClass("html-active")},_html_ended:function(e){this._track("Complete"),this.fire("ended"),this._percentPlayed=0},_playHtmlVideo:function(){var e=this;e.isPaused=!1,e.started=!0,this._video.setAttribute("controls","true"),this._video.invoke("play")},_pauseHtmlVideo:function(){var e=arguments[0],t=arguments[0]?arguments[0][0]:!1,n=this;this.isPaused=!0,this._video.invoke("pause")},_stopHtmlVideo:function(){var e=this;this._video.invoke("pause"),this.type=="live"&&this.model.set("userstopped",!0),this._percentPlayed=0,this.fire("stop"),this._track("Stop")},_destroyHtmlVideo:function(){this.model.clear()},_removeHtmlVideo:function(){},_track:function(t,n){var r=this;slug=r.model.slug,videoCategory="VODVideo",n=n||{},this.embed==1?(videoCategory="EmbedVideo",this.type==="live"?videoCategory="EmbedLiveVideo":this.type==="archive"&&(videoCategory="EmbedArchiveVideo")):this.type==="live"?videoCategory="LiveVideo":this.type==="archive"&&(videoCategory="ArchiveVideo"),e.fire("interact",e.merge(n,{category:videoCategory,action:t,label:slug}))},_swf:null,_getGlobalCallback:function(t){var n=this,r="Env.Vdgm.VideoPlayer",i=e.namespace.call(YUI,r);return i[t]=function(t,r,i){r=="onJavaScriptBridgeCreated"&&(n.player=document.getElementById(t),n.playerNode=e.one("#"+t)),n["_flash_"+r]&&n["_flash_"+r].call(n,i),n["_flash_"+t]&&n["_flash_"+t].call(n,i)},"YUI."+r+"."+t},_flash_progress:function(e){this.fire("progress")},_flash_onJavaScriptBridgeCreated:function(e){},_flash_timeChange:function(e){var t=e.currentTime;this.model.timeoffset&&(t+=this.model.timeoffset);if(this.meta&&this.meta.length>0&&this.meta.length>this.timeIterator){var n=Number(this.meta[this.timeIterator].offset);t>n&&(this.fire("updateMeta",{currentTime:t,meta:this.meta}),this.timeIterator++)}this._percentPlayed<25?t/this.duration>=.25&&(this._track("PercentPlayed25"),this._percentPlayed=25):this._percentPlayed<50?t/this.duration>=.5&&(this._track("PercentPlayed50"),this._percentPlayed=50):this._percentPlayed<75?t/this.duration>=.75&&(this._track("PercentPlayed75"),this._percentPlayed=75):this._percentPlayed<90&&t/this.duration>=.9&&(this._track("PercentPlayed90"),this._percentPlayed=90);if(!this._loadStarted){var r=this._swf.getDOMNode(),i=this.model.get("timeoffset")?Number(this.model.get("timeoffset")):0;i!=0&&this._setCurrentTime(i),this._loadStarted=!0}},_flash_seeked:function(e){var t=this._swf.getDOMNode(),n=t.getCurrentTime();this.model.timeoffset&&(n+=this.model.timeoffset),this.fire("updateMeta",{currentTime:n,meta:this.meta}),this.timeIterator=0},_playPreroll:function(){var e=this;this._preroll.shown=!0,this.player.displayAd({id:"preroll",url:this._preroll.src,hideScrubBarWhilePlayingAd:!0,pauseMainMediaWhilePlayingAd:!0,resumePlaybackAfterAd:!0,onComplete:e._getGlobalCallback(this.player._yuid)})},_flash_playing:function(e){this._track("Start"),this.fire("play");var t=this;t.isPaused=!1,t.started=!0,this._preroll&&!this._preroll.shown&&this._playPreroll(),this._flash_playing=function(e){var t=this;t.isPaused=!1,t.started=!0,this.fire("play"),this._preroll&&!this._preroll.shown&&this._playPreroll()}},_flash_paused:function(e){if(this._preroll&&this._preroll.shown&&!this._preroll.complete)return;if(this._postroll&&this._postroll.shown&&!this._postroll.complete)return;this.fire("pause"),this._track("Pause")},_flash_stopVideo:function(e){this._track("Stop"),this.fire("stop"),this._percentPlayed=0,this.type=="live"&&this.model.set("userstopped",!0),this.stop()},_flash_mediaSize:function(e){},_flash_error:function(e){this._percentPlayed=0,this.stop()},_flash_complete:function(e){var t=this;if(this._postroll){if(this._postroll.shown&&this._postroll.complete){this._percentPlayed=0,this._track("Complete"),this.fire("ended");return}this._postroll.shown=!0,this.player.displayAd({id:"postroll",url:this._postroll.src,hideScrubBarWhilePlayingAd:!0,pauseMainMediaWhilePlayingAd:!0,onComplete:t._getGlobalCallback(this.player._yuid)})}else this._percentPlayed=0,this._track("Complete"),this.fire("ended")},_flash_preroll:function(e){this._preroll.complete=!0},_flash_postroll:function(e){this._postroll.complete=!0},_flash_toggleLargeVideo:function(e){this.toggleLarge()},_loadStarted:!1,_getPosterImage:function(){var t,n=this,r=n.f4mhost?n.f4mhost:n.host;return e.Vdgm.app?t=n.model.images?n.model.images[285].imageUrl:"":t=r+(n.model.images[1140]?n.model.images[1140].imageUrl:""),t},_autoplay:self.embed!=1,_renderFlashVideo:function(){var t=this,n=this.type+"-f4m/"+t.model.slug,r=t._assetPath+"GrindPlayer.swf",i=t._assetPath+"expressInstall.swf",s=this.get("contentBox"),o=s.appendChild("<div></div>"),u=t.model.preroll,a=t.model.postrolls,f=t._getPosterImage(),l=o.generateID(),c={autoPlay:t._autoplay,javascriptCallbackFunction:t._getGlobalCallback(l),bufferingOverlay:!1,initialBufferTime:3,expandedBufferTime:10,tintColor:t.tintColor,poster:f,embed:t.embed==1,showIntermediateButton:e.Vdgm.app?t.embed!=1:!1},h={wmode:"opaque"},p={allowFullScreen:!0,allowScriptAccess:"always",wmode:"opaque",name:l};this.type=="live"?(c.src=t.flashLiveStream,t.model.set("userstopped",!1)):t.f4mhost?c.src="http://"+t.f4mhost+"/api/"+n+".f4m":t.host&e.Vdgm.app?c.src="http://"+t.host+"/api/"+n+".f4m":c.src=this.getVideo("ios").videoUrls.ios;if(u!=null&&u!=undefined){var d="";t.host?u.promo_type=="channel"?d="http://"+t.host+"/api/promo-f4m/channel/preroll/"+u.channelSlug+".f4m":d="http://"+t.host+"/api/promo-f4m/video/preroll/"+t.model.slug+".f4m":d=this.getVideo("ios").videoUrls.ios,this._preroll={src:d,shown:!1,complete:!1}}if(a!=null&&a!=undefined){var v="";t.host?a.promo_type=="channel"?v="http://"+t.host+"/api/promo-f4m/channel/postroll/"+a.channelSlug+".f4m":v="http://"+t.host+"/api/promo-f4m/video/postroll/"+t.model.slug+".f4m":v=this.getVideo("ios")
.videoUrls.ios,this._postroll={src:v,shown:!1,complete:!1}}this.timeIterator=0,e.swfobject.embedSWF(r,l,"100%","100%","10.1.0",i,c,h,p,function(n){n.success?(t._swf=e.Node(n.ref),t.type=="live"&&t._flash_playing(null)):(o.remove(),t._renderGetFlashMessage())});if(!t._autoplay){var m=t.get("boundingBox").one(".yui3-videoplayer-content");m.addClass("icon-play vdgm-icon-play"),t.model.images&&t.model.images[1140]&&(m.setStyle("background-image","url("+t._getPosterImage()+")"),console.log(t._getPosterImage())),t.once("play",function(n){m.setStyle("background-image","none"),m.removeClass("icon-play vdgm-icon-play"),e.later(1e3,t,t._playFlashVideo)})}},_bindFlashVideo:function(){},_playFlashVideo:function(){var t=this._swf.getDOMNode(),n=this;try{n.player&&t.getCanPlay()?t.play2():e.later(200,this,n._playFlashVideo)}catch(r){e.later(200,this,n._playFlashVideo)}},_pauseFlashVideo:function(){var e=arguments[0],t=this;if(this.type!="live"&&t.player&&t.player.getPlaying()){var n=t.player;n.pause&&n.pause(),t.isPaused=!0}},_stopFlashVideo:function(){this._pauseFlashVideo(),this._track("Stop"),this._percentPlayed=0,this.type=="live"&&this.model.set("userstopped",!0),this.fire("stop")},_removeFlashVideo:function(){this.player&&this._swf.remove(!0)},_destroyFlashVideo:function(){this.player&&this._swf.remove(!0),this.model.clear()},_renderGetFlashMessage:function(){var t=this.get("contentBox");t.appendChild(e.Node.create(n.GET_FLASH_TEMPLATE))}}),e.Vdgm.app&&e.augment(n,e.Vdgm.Logger)},"0.0.1",{requires:["node-event-html5","widget","vdgm-logr","swfobject","swf","widget-parent","widget-child"],skinnable:!0});
